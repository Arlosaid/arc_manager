{% extends 'base.html' %}
{% load static %}

{% block title %}Mi Organizaci√≥n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/organization_management.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/organization_management.js' %}"></script>
{% endblock %}

{% block content %}
<div class="organization-container">
    <!-- Header simplificado -->
    <div class="org-header">
        <div class="org-header-content">
            <div class="org-info">
                <div class="org-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="org-details">
                    <h1>{{ organization.name }}</h1>
                    {% if user.is_org_admin %}
                        <div class="org-role">
                            <i class="fas fa-crown"></i> Administrador
                        </div>
                    {% else %}
                        <div class="org-role">
                            <i class="fas fa-user"></i> Miembro
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="org-status">
                {% if organization.is_active %}
                    <i class="fas fa-check-circle"></i>
                    <span>Activa</span>
                {% else %}
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Inactiva</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Alerta de trial mejorada -->
    {% if organization.is_trial and organization.trial_days_remaining %}
        <div class="trial-warning-card {% if organization.trial_days_remaining <= 3 %}trial-urgent{% elif organization.trial_days_remaining <= 7 %}trial-warning{% endif %}" role="alert" aria-live="polite">
            <div class="trial-icon">
                {% if organization.trial_days_remaining <= 3 %}
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                {% elif organization.trial_days_remaining <= 7 %}
                    <i class="fas fa-clock" aria-hidden="true"></i>
                {% else %}
                    <i class="fas fa-fire" aria-hidden="true"></i>
                {% endif %}
            </div>
            
            {% if organization.trial_days_remaining <= 3 %}
                <div class="trial-title">‚ö†Ô∏è Tu prueba expira pronto</div>
                <div class="trial-days">{{ organization.trial_days_remaining }} d√≠a{{ organization.trial_days_remaining|pluralize }}</div>
                <div class="trial-subtitle">
                    {% if organization.trial_days_remaining == 1 %}
                        ¬°√öltimo d√≠a! Tu acceso se suspender√° ma√±ana
                    {% else %}
                        Tu acceso se suspender√° en {{ organization.trial_days_remaining }} d√≠as
                    {% endif %}
                </div>
                <div class="trial-consequences">
                    Sin actualizar: perder√°s acceso a usuarios y funciones
                </div>
            {% elif organization.trial_days_remaining <= 7 %}
                <div class="trial-title">‚è∞ Prueba terminando</div>
                <div class="trial-days">{{ organization.trial_days_remaining }} d√≠a{{ organization.trial_days_remaining|pluralize }}</div>
                <div class="trial-subtitle">restantes de tu per√≠odo de prueba</div>
                <div class="trial-benefits">
                    Actualiza ahora y mant√©n todos tus usuarios y datos
                </div>
            {% else %}
                <div class="trial-title">üî• Per√≠odo de Prueba Activo</div>
                <div class="trial-days">{{ organization.trial_days_remaining }} d√≠a{{ organization.trial_days_remaining|pluralize }}</div>
                <div class="trial-subtitle">para explorar todas las funciones</div>
                <div class="trial-benefits">
                    Usuarios ilimitados ‚Ä¢ Soporte prioritario ‚Ä¢ Sin restricciones
                </div>
            {% endif %}
            
            <div class="trial-actions">
                <a href="{% url 'plans:pricing' %}" class="btn-primary-improved" aria-label="{% if organization.trial_days_remaining <= 3 %}Actualizar plan ahora{% else %}Ver planes disponibles{% endif %}">
                    <i class="fas fa-rocket" aria-hidden="true"></i>
                    {% if organization.trial_days_remaining <= 3 %}
                        Actualizar Ahora
                    {% else %}
                        Ver Planes
                    {% endif %}
                </a>
                {% if organization.trial_days_remaining > 7 %}
                    <a href="{% url 'plans:subscription_dashboard' %}" class="btn-secondary-trial" aria-label="Ver m√°s informaci√≥n sobre suscripci√≥n">
                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                        M√°s Info
                    </a>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Contenido principal -->
    <div class="main-content-grid">
        <!-- Plan actual -->
        <div class="info-card plan-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-box"></i>
                </div>
                <h3 class="card-title">Plan Actual</h3>
            </div>
            {% if organization.plan %}
                <div class="plan-name">{{ organization.plan.display_name }}</div>
                <div class="plan-price">
                    {% if organization.plan.price > 0 %}
                        ${{ organization.plan.price }}/mes
                    {% else %}
                        Gratuito
                    {% endif %}
                </div>
                <div class="stat-item">
                    <span class="stat-label">L√≠mite de usuarios</span>
                    <span class="stat-value">{{ organization.get_max_users }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Estado</span>
                    {% if organization.is_subscription_active %}
                        <span class="stat-badge">Activa</span>
                    {% else %}
                        <span class="stat-badge danger">Inactiva</span>
                    {% endif %}
                </div>
            {% else %}
                <p style="color: #64748b; text-align: center;">No hay plan asignado</p>
            {% endif %}
        </div>

        <!-- Estad√≠sticas de usuarios -->
        <div class="info-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="card-title">Usuarios</h3>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total</span>
                <span class="stat-value">{{ organization.get_user_count }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Activos</span>
                <span class="stat-value">{{ organization.get_active_user_count }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Administradores</span>
                <span class="stat-value">{{ organization.get_admins.count }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Capacidad</span>
                {% with max_users=organization.get_max_users %}
                    {% if max_users > 0 %}
                        {% widthratio organization.get_user_count max_users 100 as percentage %}
                        {% if percentage >= 90 %}
                            <span class="stat-badge danger">{{ percentage }}%</span>
                        {% elif percentage >= 70 %}
                            <span class="stat-badge warning">{{ percentage }}%</span>
                        {% else %}
                            <span class="stat-badge">{{ percentage }}%</span>
                        {% endif %}
                    {% else %}
                        <span class="stat-badge danger">N/A</span>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Acciones r√°pidas -->
    {% if user.is_org_admin %}
        <div class="quick-actions">
            <a href="{% url 'users:user_list' %}" class="action-card" aria-label="Gestionar usuarios de la organizaci√≥n">
                <div class="action-icon">
                    <i class="fas fa-users" aria-hidden="true"></i>
                </div>
                <div class="action-title">Gestionar Usuarios</div>
                <div class="action-description">Crear y administrar usuarios</div>
            </a>
            
            <a href="{% url 'plans:subscription_dashboard' %}" class="action-card" aria-label="Ver dashboard de suscripci√≥n">
                <div class="action-icon">
                    <i class="fas fa-credit-card" aria-hidden="true"></i>
                </div>
                <div class="action-title">Suscripci√≥n</div>
                <div class="action-description">Ver plan y facturaci√≥n</div>
            </a>
            
            <a href="{% url 'plans:pricing' %}" class="action-card" aria-label="Actualizar plan de suscripci√≥n">
                <div class="action-icon">
                    <i class="fas fa-rocket" aria-hidden="true"></i>
                </div>
                <div class="action-title">Actualizar Plan</div>
                <div class="action-description">Explorar m√°s opciones</div>
            </a>
        </div>
    {% endif %}

    <!-- Mensaje de soporte -->
    <div class="support-message">
        <i class="fas fa-info-circle"></i>
        <span>Para cambios en la organizaci√≥n, contacta al soporte</span>
    </div>
</div>
{% endblock %} 