{% extends "base.html" %}
{% load static %}

{% block title %}Actualizar Plan{% endblock %}

{% block extra_css %}
<style>
    .upgrade-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .current-plan-card {
        border-left: 4px solid #28a745;
        background: #f8f9fa;
    }
    
    .upgrade-plan-card {
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    
    .upgrade-plan-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        border-color: #667eea;
    }
    
    .upgrade-plan-card.selected {
        border-color: #28a745;
        background: #f8fff9;
    }
    
    .price-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50px;
        padding: 0.5rem 1rem;
        font-weight: bold;
    }
    
    .feature-comparison {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    /* Modal Styles - Simple y funcional */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .custom-modal.show {
        display: flex;
        opacity: 1;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background-color: white;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.7);
        transition: transform 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .custom-modal.show .modal-content {
        transform: scale(1);
    }
    
    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-close:hover {
        color: #000;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
        border-radius: 0 0 8px 8px;
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }
    
    /* Botones */
    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #545b62;
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .btn-loading {
        position: relative;
    }
    
    /* Prevenir scroll cuando modal está abierto */
    body.modal-open {
        overflow: hidden;
    }
    
    /* Loading spinner */
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

{% if error %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h5>Error</h5>
                <p>{{ error }}</p>
                <a href="{% url 'plans:subscription_dashboard' %}" class="btn btn-primary">
                    Volver al Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% else %}

<!-- Header -->
<div class="upgrade-header">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <h1 class="h2 mb-2">
                    <i class="fas fa-arrow-up me-2"></i>
                    Actualizar Plan
                </h1>
                <p class="mb-0" style="opacity: 0.75;">
                    Obtén más recursos y funcionalidades para tu organización
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Plan Actual -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card current-plan-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Plan Actual: {{ current_subscription.plan.display_name }}
                            </h5>
                            <p class="text-muted mb-0">
                                {{ current_subscription.plan.description }}
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="price-badge">
                                ${{ current_subscription.plan.price|floatformat:0 }}/mes
                            </div>
                            <small class="text-muted d-block mt-1">
                                Vence: {{ current_subscription.end_date|date:"d/m/Y" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Planes Disponibles -->
    {% if available_plans %}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="mb-4">Planes Disponibles para Upgrade</h3>
        </div>
        {% for plan in available_plans %}
        <div class="col-lg-6 mb-4">
            <div class="card upgrade-plan-card h-100" data-plan-id="{{ plan.id }}">
                <div class="card-header text-center">
                    <h4 class="font-weight-bold">{{ plan.display_name }}</h4>
                    <div class="h2 text-primary mb-0">
                        ${{ plan.price|floatformat:0 }}
                        <small class="text-muted">/mes</small>
                    </div>
                </div>
                
                <div class="card-body">
                    <p class="text-muted mb-3">{{ plan.description }}</p>
                    
                    <!-- Características principales -->
                    <div class="mb-3">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="border-end">
                                    <div class="h5 text-primary mb-0">{{ plan.max_users }}</div>
                                    <small class="text-muted">Usuarios</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-end">
                                    <div class="h5 text-primary mb-0">{{ plan.max_projects }}</div>
                                    <small class="text-muted">Proyectos</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="h5 text-primary mb-0">{{ plan.storage_limit_gb }}GB</div>
                                <small class="text-muted">Almacenamiento</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Características adicionales -->
                    <ul class="list-unstyled">
                        {% for feature in plan.get_feature_list %}
                        <li class="mb-1">
                            <i class="fas fa-check text-success me-2"></i>
                            {{ feature }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div class="card-footer text-center">
                    <button class="btn btn-primary w-100 upgrade-btn" 
                            data-plan-id="{{ plan.id }}"
                            data-plan-name="{{ plan.display_name }}"
                            data-plan-price="{{ plan.price }}">
                        <i class="fas fa-arrow-up me-2"></i>
                        Actualizar a este Plan
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-trophy fa-3x text-warning mb-3"></i>
                    <h5>¡Ya tienes el mejor plan!</h5>
                    <p class="text-muted">
                        Actualmente estás en el plan más avanzado disponible.
                        Te notificaremos cuando tengamos nuevos planes disponibles.
                    </p>
                    <a href="{% url 'plans:subscription_dashboard' %}" class="btn btn-primary">
                        Volver al Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Comparación de Características -->
    {% if available_plans %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="feature-comparison p-4">
                <h4 class="mb-4 text-center">Comparación de Planes</h4>
                
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Característica</th>
                                <th class="text-center">{{ current_subscription.plan.display_name }}</th>
                                {% for plan in available_plans %}
                                <th class="text-center">{{ plan.display_name }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Usuarios</strong></td>
                                <td class="text-center">{{ current_subscription.plan.max_users }}</td>
                                {% for plan in available_plans %}
                                <td class="text-center text-success"><strong>{{ plan.max_users }}</strong></td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Proyectos</strong></td>
                                <td class="text-center">{{ current_subscription.plan.max_projects }}</td>
                                {% for plan in available_plans %}
                                <td class="text-center text-success"><strong>{{ plan.max_projects }}</strong></td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Almacenamiento</strong></td>
                                <td class="text-center">{{ current_subscription.plan.storage_limit_gb }} GB</td>
                                {% for plan in available_plans %}
                                <td class="text-center text-success"><strong>{{ plan.storage_limit_gb }} GB</strong></td>
                                {% endfor %}
                            </tr>
                            <tr>
                                <td><strong>Precio Mensual</strong></td>
                                <td class="text-center">${{ current_subscription.plan.price|floatformat:0 }}</td>
                                {% for plan in available_plans %}
                                <td class="text-center"><strong>${{ plan.price|floatformat:0 }}</strong></td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Personalizado -->
<div id="upgradeModal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Confirmar Actualización de Plan</h5>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="text-center mb-4">
                <i class="fas fa-paper-plane fa-3x text-primary mb-3"></i>
                <h6>¿Estás seguro de que quieres solicitar un upgrade a:</h6>
                <h4 id="modal-plan-name" class="text-primary"></h4>
                <p class="text-muted">Precio: <span id="modal-plan-price"></span>/mes</p>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Nuevo Proceso de Upgrade:</strong><br>
                1. Se enviará tu solicitud al administrador<br>
                2. Recibirás aprobación e instrucciones de pago por email<br>
                3. Realizas el pago según las instrucciones<br>
                4. Reportas tu pago y se activa el nuevo plan<br>
                <br>
                <small class="text-muted">⏱️ Tiempo estimado: 24-48 horas</small>
            </div>
            
            <!-- Formulario opcional para notas -->
            <div class="mb-3">
                <label for="upgrade-notes" class="form-label">
                    <i class="fas fa-comment me-1"></i>
                    Notas adicionales (opcional):
                </label>
                <textarea id="upgrade-notes" class="form-control" rows="3" 
                         placeholder="Ej: Necesito el upgrade urgente para mi proyecto..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirm-upgrade-btn" onclick="confirmUpgrade()">
                <i class="fas fa-paper-plane me-2"></i>
                Enviar Solicitud
            </button>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let selectedPlanData = {};

// Función para obtener CSRF token
function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
}

// Función para abrir el modal
function openModal(planId, planName, planPrice) {
    console.log('Abriendo modal para:', planId, planName, planPrice);
    
    selectedPlanData = {
        id: planId,
        name: planName,
        price: planPrice
    };
    
    // Actualizar contenido del modal
    document.getElementById('modal-plan-name').textContent = planName;
    document.getElementById('modal-plan-price').textContent = '$' + planPrice;
    
    // Mostrar modal
    const modal = document.getElementById('upgradeModal');
    document.body.classList.add('modal-open');
    modal.classList.add('show');
    
    console.log('Modal abierto');
}

// Función para cerrar el modal
function closeModal() {
    console.log('Cerrando modal');
    
    const modal = document.getElementById('upgradeModal');
    document.body.classList.remove('modal-open');
    modal.classList.remove('show');
    
    // Limpiar datos
    selectedPlanData = {};
    
    // Restaurar botón
    const confirmBtn = document.getElementById('confirm-upgrade-btn');
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Solicitud';
    
    console.log('Modal cerrado');
}

// Función para confirmar el upgrade
function confirmUpgrade() {
    console.log('Confirmando upgrade para:', selectedPlanData);
    
    if (!selectedPlanData.id) {
        alert('Error: No hay plan seleccionado');
        return;
    }
    
    const confirmBtn = document.getElementById('confirm-upgrade-btn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<span class="spinner me-2"></span>Enviando solicitud...';
    
    // Preparar datos para envío
    const formData = new FormData();
    formData.append('plan_id', selectedPlanData.id);
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    // Agregar notas si las hay
    const notes = document.getElementById('upgrade-notes')?.value || '';
    if (notes.trim()) {
        formData.append('notes', notes.trim());
    }
    
    // Enviar petición
    fetch('{% url "plans:upgrade_plan" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Respuesta:', data);
        
        if (data.success) {
            // Cerrar modal
            closeModal();
            
            // Mostrar mensaje de éxito con el nuevo flujo
            const successMessage = data.message || 
                `Solicitud de upgrade enviada correctamente. Te contactaremos pronto para aprobar y procesar tu solicitud.`;
            
            showSuccessMessage(successMessage);
            
            // Redirigir después de 5 segundos para que lean el mensaje
            setTimeout(() => {
                window.location.href = '{% url "plans:subscription_dashboard" %}';
            }, 5000);
            
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
            // Restaurar botón en caso de error
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Solicitud';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión: ' + error.message);
        // Restaurar botón en caso de error
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Solicitud';
    });
}

// Función para mostrar mensaje de éxito
function showSuccessMessage(message) {
    const alertHtml = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container');
    if (container) {
        container.insertAdjacentHTML('afterbegin', alertHtml);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Inicializar eventos cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando eventos del modal');
    
    // Event listeners para botones de upgrade
    document.querySelectorAll('.upgrade-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const planId = this.getAttribute('data-plan-id');
            const planName = this.getAttribute('data-plan-name');
            const planPrice = this.getAttribute('data-plan-price');
            
            console.log('Botón clickeado:', planId, planName, planPrice);
            openModal(planId, planName, planPrice);
        });
    });
    
    // Cerrar modal al hacer click fuera del contenido
    document.getElementById('upgradeModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
    
    console.log('Eventos inicializados correctamente');
});
</script>
{% endblock %} 
