{% extends 'base.html' %}
{% load static %}
{% load plan_extras %}

{% block title %}Dashboard de Suscripción - Arc Manager{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="{% static 'css/subscription_dashboard.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="header-content">
            <div class="header-title">
                <div class="header-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <h1>Mi Suscripción</h1>
            </div>
        </div>
    </div>

    <div class="main-content-grid">
        <div class="left-content">
            <!-- Usage Statistics - MOVED TO TOP AND ENHANCED -->
            <div class="usage-hero-section">
                <div class="usage-hero-header">
                    <div class="usage-hero-title">
                        <i class="fas fa-tachometer-alt"></i>
                        <h2>Tu Uso Actual</h2>
                    </div>
                    <p class="usage-hero-subtitle">Monitorea tu consumo de recursos en tiempo real</p>
                </div>
                
                <div class="usage-metrics-enhanced">
                    <!-- Users Usage -->
                    <div class="metric-card-enhanced users-metric">
                        <div class="metric-header-enhanced">
                            <div class="metric-icon-enhanced">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="metric-info-enhanced">
                                <h3>Usuarios</h3>
                                <div class="metric-numbers-enhanced">
                                    <span class="current-enhanced">{{ usage_stats.users.current }}</span>
                                    <span class="separator-enhanced">/</span>
                                    <span class="limit-enhanced">{{ usage_stats.users.limit }}</span>
                                </div>
                            </div>
                            <div class="metric-percentage-enhanced">
                                {{ usage_stats.users.percentage|floatformat:0 }}%
                            </div>
                        </div>
                        
                        <div class="metric-progress-enhanced">
                            <div class="progress-track-enhanced">
                                <div class="progress-fill-enhanced users-color" data-width="{{ usage_stats.users.percentage }}"></div>
                            </div>
                        </div>
                        
                        <div class="metric-status-enhanced">
                            {% if usage_stats.users.is_at_limit %}
                                <div class="status-critical-enhanced">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>¡Límite alcanzado!</span>
                                    <a href="{% url 'plans:request_upgrade' %}" class="status-action-enhanced">Actualizar Plan</a>
                                </div>
                            {% elif usage_stats.users.percentage >= 80 %}
                                <div class="status-warning-enhanced">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span>Cerca del límite - {{ usage_stats.users.available }} restantes</span>
                                    <a href="{% url 'plans:request_upgrade' %}" class="status-action-enhanced">Ver Planes</a>
                                </div>
                            {% else %}
                                <div class="status-ok-enhanced">
                                    <i class="fas fa-check-circle"></i>
                                    <span>{{ usage_stats.users.available }} espacios disponibles</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Projects Usage -->
                    <div class="metric-card-enhanced projects-metric">
                        <div class="metric-header-enhanced">
                            <div class="metric-icon-enhanced">
                                <i class="fas fa-folder"></i>
                            </div>
                            <div class="metric-info-enhanced">
                                <h3>Proyectos</h3>
                                <div class="metric-numbers-enhanced">
                                    <span class="current-enhanced">{{ usage_stats.projects.current }}</span>
                                    <span class="separator-enhanced">/</span>
                                    <span class="limit-enhanced">{{ usage_stats.projects.limit }}</span>
                                </div>
                            </div>
                            <div class="metric-percentage-enhanced">
                                {{ usage_stats.projects.percentage|floatformat:0 }}%
                            </div>
                        </div>
                        
                        <div class="metric-progress-enhanced">
                            <div class="progress-track-enhanced">
                                <div class="progress-fill-enhanced projects-color" data-width="{{ usage_stats.projects.percentage }}"></div>
                            </div>
                        </div>
                        
                        <div class="metric-status-enhanced">
                            {% if usage_stats.projects.current >= usage_stats.projects.limit %}
                                <div class="status-critical-enhanced">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>¡Límite alcanzado!</span>
                                    <a href="{% url 'plans:request_upgrade' %}" class="status-action-enhanced">Actualizar Plan</a>
                                </div>
                            {% elif usage_stats.projects.percentage >= 80 %}
                                <div class="status-warning-enhanced">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span>Cerca del límite - {{ usage_stats.projects.available }} restantes</span>
                                    <a href="{% url 'plans:request_upgrade' %}" class="status-action-enhanced">Ver Planes</a>
                                </div>
                            {% elif usage_stats.projects.current == 0 %}
                                <div class="status-empty-enhanced">
                                    <i class="fas fa-plus-circle"></i>
                                    <span>¡Crea tu primer proyecto!</span>
                                    <a href="#" class="status-action-enhanced">Nuevo Proyecto</a>
                                </div>
                            {% else %}
                                <div class="status-ok-enhanced">
                                    <i class="fas fa-check-circle"></i>
                                    <span>{{ usage_stats.projects.available }} espacios disponibles</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Storage Usage -->
                    <div class="metric-card-enhanced storage-metric">
                        <div class="metric-header-enhanced">
                            <div class="metric-icon-enhanced">
                                <i class="fas fa-hdd"></i>
                            </div>
                            <div class="metric-info-enhanced">
                                <h3>Almacenamiento</h3>
                                <div class="metric-numbers-enhanced">
                                    <span class="current-enhanced">{{ usage_stats.storage.current_gb|floatformat:1 }} GB</span>
                                    <span class="separator-enhanced">/</span>
                                    <span class="limit-enhanced">{{ usage_stats.storage.limit }} GB</span>
                                </div>
                            </div>
                            <div class="metric-percentage-enhanced">
                                {{ usage_stats.storage.percentage|floatformat:0 }}%
                            </div>
                        </div>
                        
                        <div class="metric-progress-enhanced">
                            <div class="progress-track-enhanced">
                                <div class="progress-fill-enhanced storage-color" data-width="{{ usage_stats.storage.percentage }}"></div>
                            </div>
                        </div>
                        
                        <div class="metric-status-enhanced">
                            {% if usage_stats.storage.current_gb >= usage_stats.storage.limit %}
                                <div class="status-critical-enhanced">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>¡Sin espacio disponible!</span>
                                    <a href="{% url 'plans:request_upgrade' %}" class="status-action-enhanced">Más Espacio</a>
                                </div>
                            {% elif usage_stats.storage.percentage >= 80 %}
                                <div class="status-warning-enhanced">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span>Poco espacio - {{ usage_stats.storage.available_gb|floatformat:1 }} GB restantes</span>
                                    <a href="{% url 'plans:request_upgrade' %}" class="status-action-enhanced">Más Espacio</a>
                                </div>
                            {% else %}
                                <div class="status-ok-enhanced">
                                    <i class="fas fa-check-circle"></i>
                                    <span>{{ usage_stats.storage.available_gb|floatformat:1 }} GB disponibles</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Upgrade CTA if needed -->
                {% if not organization.subscription.plan.name == 'premium' %}
                <div class="upgrade-cta-enhanced">
                    <div class="cta-content-enhanced">
                        <div class="cta-icon-enhanced">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div class="cta-text-enhanced">
                            <h4>{% if organization.subscription.plan.name == 'trial' %}¿Listo para más recursos?{% else %}¿Necesitas más capacidad?{% endif %}</h4>
                            <p>{% if organization.subscription.plan.name == 'trial' %}Desbloquea el potencial completo con un plan ilimitado{% else %}Obtén 5x más capacidad con el Plan Premium{% endif %}</p>
                        </div>
                        <div class="cta-action-enhanced">
                            <a href="{% url 'plans:request_upgrade' %}" class="cta-button-enhanced">
                                <i class="fas fa-arrow-right"></i>
                                {% if organization.subscription.plan.name == 'trial' %}Elegir Plan{% else %}Actualizar{% endif %}
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Current Plan Card -->
            <div class="subscription-card current-plan card shadow-sm mb-4">
                <div class="card-header">
                    <div class="plan-info">
                        <h2 class="plan-name">
                            {{ organization.subscription.plan.display_name }}
                            {% if organization.subscription.plan.is_featured %}
                                <span class="popular-badge">
                                    <i class="fas fa-star"></i>
                                    Más Popular
                                </span>
                            {% endif %}
                        </h2>
                        <div class="plan-price">
                            <span class="price-amount">{{ organization.subscription.plan.price_display }}</span>
                            <span class="price-period">{{ organization.subscription.plan.billing_display }}</span>
                        </div>
                    </div>
                    <div class="plan-status">
                        <span class="status-badge {{ organization.subscription.status }}">
                            {% if organization.subscription.status == 'active' %}
                                <i class="fas fa-check-circle"></i>
                                Activa
                            {% elif organization.subscription.status == 'trial' %}
                                <i class="fas fa-clock"></i>
                                En Prueba
                            {% elif organization.subscription.status == 'expired' %}
                                <i class="fas fa-exclamation-triangle"></i>
                                Expirada
                            {% elif organization.subscription.status == 'cancelled' %}
                                <i class="fas fa-times-circle"></i>
                                Cancelada
                            {% endif %}
                        </span>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Subscription Details -->
                    <div class="subscription-details">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Inicio:</span>
                                <span class="detail-value">{{ organization.subscription.start_date|date:"d/m/Y" }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">{% if organization.subscription.is_trial %}Fin de prueba:{% else %}Renovación:{% endif %}</span>
                                <span class="detail-value">{{ organization.subscription.end_date|date:"d/m/Y" }}</span>
                            </div>
                        </div>

                        {% comment %}Alerta Universal para Trial y Renovaciones{% endcomment %}
                        {% if organization.subscription.is_trial %}
                            <!-- Alerta de Trial -->
                            <div class="trial-alert {% if subscription_status.trial_days_remaining <= 2 %}urgent{% elif subscription_status.trial_days_remaining <= 7 %}warning{% endif %}">
                                <div class="trial-content">
                                    <div class="trial-icon">
                                        {% if subscription_status.trial_days_remaining <= 2 %}
                                            <i class="fas fa-exclamation-triangle"></i>
                                        {% elif subscription_status.trial_days_remaining <= 7 %}
                                            <i class="fas fa-hourglass-half"></i>
                                        {% else %}
                                            <i class="fas fa-clock"></i>
                                        {% endif %}
                                    </div>
                                    <div class="trial-text">
                                        {% if subscription_status.trial_days_remaining <= 2 %}
                                            <h4>⚠️ Tu prueba expira muy pronto</h4>
                                            <p>Solo te quedan <span class="trial-days">{{ subscription_status.trial_days_remaining }} día{{ subscription_status.trial_days_remaining|pluralize }}</span> antes de que se suspenda el acceso.</p>
                                        {% elif subscription_status.trial_days_remaining <= 7 %}
                                            <h4>⏰ Tu prueba expira pronto</h4>
                                            <p>Te quedan <span class="trial-days">{{ subscription_status.trial_days_remaining }} día{{ subscription_status.trial_days_remaining|pluralize }}</span> para decidir tu plan.</p>
                                        {% else %}
                                            <h4>🔥 Período de Prueba Activo</h4>
                                            <p>Te quedan <span class="trial-days">{{ subscription_status.trial_days_remaining }} día{{ subscription_status.trial_days_remaining|pluralize }}</span> para explorar todas las funciones.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% elif organization.subscription.status == 'active' and subscription_status.renewal_days_remaining <= 30 %}
                            <!-- Alerta de Renovación -->
                            <div class="trial-alert renewal {% if subscription_status.renewal_days_remaining <= 3 %}urgent{% elif subscription_status.renewal_days_remaining <= 7 %}warning{% endif %}">
                                <div class="trial-content">
                                    <div class="trial-icon">
                                        {% if subscription_status.renewal_days_remaining <= 3 %}
                                            <i class="fas fa-exclamation-triangle"></i>
                                        {% elif subscription_status.renewal_days_remaining <= 7 %}
                                            <i class="fas fa-credit-card"></i>
                                        {% else %}
                                            <i class="fas fa-calendar-alt"></i>
                                        {% endif %}
                                    </div>
                                    <div class="trial-text">
                                        {% if subscription_status.renewal_days_remaining <= 3 %}
                                            <h4>💳 Renovación Urgente</h4>
                                            <p>Tu suscripción vence en <span class="trial-days">{{ subscription_status.renewal_days_remaining }} día{{ subscription_status.renewal_days_remaining|pluralize }}</span>. Renueva para continuar sin interrupciones.</p>
                                        {% elif subscription_status.renewal_days_remaining <= 7 %}
                                            <h4>📅 Próxima Renovación</h4>
                                            <p>Tu suscripción se renueva en <span class="trial-days">{{ subscription_status.renewal_days_remaining }} día{{ subscription_status.renewal_days_remaining|pluralize }}</span>. Asegúrate de tener fondos disponibles.</p>
                                        {% else %}
                                            <h4>🔄 Recordatorio de Renovación</h4>
                                            <p>Tu suscripción se renueva en <span class="trial-days">{{ subscription_status.renewal_days_remaining }} día{{ subscription_status.trial_days_remaining|pluralize }}</span>.</p>
                                        {% endif %}
                                    </div>
                                    <a href="{% url 'plans:subscription_dashboard' %}" class="trial-button">
                                        {% if subscription_status.renewal_days_remaining <= 3 %}
                                            <i class="fas fa-credit-card"></i> Renovar Ya
                                        {% else %}
                                            <i class="fas fa-cog"></i> Gestionar
                                        {% endif %}
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Plan Features -->
                    <div class="plan-features">
                        <h4>Características de tu plan:</h4>
                        <ul class="features-list">
                            {% for feature in organization.subscription.plan.get_feature_list %}
                            <li class="feature-item">
                                <i class="fas fa-check feature-check"></i>
                                <span>{{ feature }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <div class="card-footer">
                    {% if organization.subscription.is_trial %}
                        <a href="{% url 'plans:request_upgrade' %}" class="upgrade-btn-prominent btn btn-gradient shadow-sm">
                            <i class="fas fa-rocket btn-icon"></i>
                            Mejorar mi plan
                        </a>
                        <p class="upgrade-subtitle">
                            Desbloquea más usuarios, proyectos y almacenamiento
                        </p>
                    {% elif organization.subscription.status == 'active' %}
                        <div class="action-buttons">
                            <button class="btn-secondary" onclick="showCancelModal()">
                                <i class="fas fa-pause"></i>
                                Pausar Suscripción
                            </button>
                        </div>
                    {% elif organization.subscription.status == 'expired' %}
                        <a href="{% url 'plans:request_upgrade' %}" class="btn-primary reactivate-btn">
                            <i class="fas fa-refresh"></i>
                            Reactivar Suscripción
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Billing History -->
            {% if billing_history %}
            <div class="billing-card card shadow-sm mb-4">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-receipt"></i>
                        Historial de Pagos
                    </h3>
                </div>
                <div class="card-body">
                    <div class="billing-table">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                    <th>Método</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in billing_history %}
                                <tr>
                                    <td>{{ payment.date|date:"d/m/Y" }}</td>
                                    <td>${{ payment.amount|floatformat:0 }} MXN</td>
                                    <td>
                                        <span class="status-badge {{ payment.status }}">
                                            {{ payment.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ payment.method|default:"Manual" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Sidebar -->
        <div class="right-sidebar">
            <!-- Plan Upgrade Card - Rediseñada -->
            {% if not organization.subscription.plan.name == 'premium' %}
            <div class="upgrade-spotlight-card mb-4">
                <div class="spotlight-header">
                    <div class="spotlight-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h4 class="spotlight-title">¡Potencia tu Productividad!</h4>
                </div>
                
                <div class="spotlight-content">
                    {% if organization.subscription.plan.name == 'trial' %}
                        <p class="spotlight-description">
                            Convierte tu prueba en una <strong>experiencia completa</strong> con el Plan Básico
                        </p>
                        <div class="spotlight-benefits">
                            <div class="benefit-item">
                                <i class="fas fa-users"></i>
                                <span>Usuarios ilimitados</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-folder"></i>
                                <span>Proyectos sin límite</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-shield-alt"></i>
                                <span>Soporte prioritario</span>
                            </div>
                        </div>
                    {% else %}
                        <p class="spotlight-description">
                            Lleva tu negocio al <strong>siguiente nivel</strong> con el Plan Premium
                        </p>
                        <div class="spotlight-benefits">
                            <div class="benefit-item">
                                <i class="fas fa-cloud"></i>
                                <span>5x más almacenamiento</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-chart-line"></i>
                                <span>Analytics avanzados</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-headset"></i>
                                <span>Soporte 24/7</span>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="spotlight-action">
                    <a href="{% url 'plans:pricing' %}" class="btn-spotlight">
                        <i class="fas fa-arrow-right"></i>
                        Explorar Planes
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Support Info Enhanced -->
            <div class="support-enhanced card shadow-sm mb-4">
                <div class="info-header-sidebar">
                    <i class="fas fa-headset"></i>
                    <h4>¿Necesitas ayuda?</h4>
                </div>
                <div class="info-content-sidebar">
                    <p>Estamos aquí para ayudarte con cualquier duda sobre tu suscripción</p>
                    
                    <div class="support-options">
                        <a href="mailto:soporte@arcmanager.com" class="support-option">
                            <i class="fas fa-envelope"></i>
                            <span>Enviar Email</span>
                        </a>
                        <a href="#" class="support-option" onclick="alert('Función de chat en desarrollo')">
                            <i class="fas fa-comments"></i>
                            <span>Chat en vivo</span>
                        </a>
                        <a href="#" class="support-option" onclick="alert('FAQ en desarrollo')">
                            <i class="fas fa-question-circle"></i>
                            <span>Preguntas frecuentes</span>
                        </a>
                        {% if organization.subscription.plan.name == 'premium' %}
                        <a href="#" class="support-option" onclick="alert('Calendario en desarrollo')">
                            <i class="fas fa-calendar"></i>
                            <span>Agendar llamada prioritaria</span>
                        </a>
                        {% endif %}
                    </div>
                    
                    {% if organization.subscription.plan.name == 'premium' %}
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--arc-color-success); font-weight: 600;">
                            <i class="fas fa-star"></i> Soporte prioritario - Respuesta en 24h
                        </p>
                    {% else %}
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--arc-text-secondary);">
                            Soporte estándar - Respuesta en 48h
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Activity -->
            {% if recent_activity %}
            <div class="info-card-sidebar">
                <div class="info-header-sidebar">
                    <i class="fas fa-clock"></i>
                    <h4>Actividad Reciente</h4>
                </div>
                <div class="info-content-sidebar">
                    {% for activity in recent_activity %}
                        <div class="activity-item">
                            <div class="activity-date">{{ activity.date|date:"d/m" }}</div>
                            <div class="activity-text">{{ activity.description }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div id="cancelModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>¿Pausar suscripción?</h3>
            <button class="modal-close" onclick="hideCancelModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Tu suscripción se pausará al final del período de facturación actual.</p>
            <p>Mantendrás acceso hasta <strong>{{ organization.subscription.end_date|date:"d/m/Y" }}</strong></p>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="hideCancelModal()">Mantener Activa</button>
            <button class="btn-danger" onclick="confirmCancel()">Pausar Suscripción</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/subscription_dashboard.js' %}"></script>
{% endblock %} 